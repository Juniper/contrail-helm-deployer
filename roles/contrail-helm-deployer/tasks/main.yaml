---
- name: Set variables
  set_fact:
    src_dir_openstack_helm: "{{ ansible_env.HOME }}/{{ zuul.projects | selectattr('short_name', 'equalto', 'openstack-helm') | map(attribute='src_dir') | list | first }}"
    src_dir_openstack_helm_infra: "{{ ansible_env.HOME }}/{{ zuul.projects | selectattr('short_name', 'equalto', 'openstack-helm-infra') | map(attribute='src_dir') | list | first }}"
    src_dir_contrail_helm_deployer: "{{ ansible_env.HOME }}/{{ zuul.projects | selectattr('short_name', 'equalto', 'contrail-helm-deployer') | map(attribute='src_dir') | list | first }}"

- name: (Hack) Drop ansible facts for debugging
  debug:
    var: hostvars[inventory_hostname]

- name: copy local vars template to target machine
  template:
    src: templates/local-vars.yaml.j2
    dest: "{{ src_dir_openstack_helm_infra }}/tools/gate/devel/local-vars.yaml"
    mode: 0644

- name: copy deployment script to target machine
  copy:
    src: helm-deploy.sh
    dest: "{{ ansible_env.HOME }}"
    mode: 0755

- name: (Hack) Walkaround to check if change VM hostname will solve deployment issue
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ ansible_default_ipv4.address }}"
    line: "{{ ansible_default_ipv4.address }} {% if ansible_domain %}{{ inventory_hostname }}.{{ ansible_domain }}{% endif %} {{ inventory_hostname }}"
  when: ansible_hostname != inventory_hostname
  become: True
  become_user: root

- name: (Hack) Walkaround to change hostname using ansible
  hostname:
    name: "{{ inventory_hostname }}"
  when: ansible_hostname != inventory_hostname
  become: True
  become_user: root

  #- name: Fetch local_vars.yaml to executor
  #  synchronize:
  #    src: "{{ src_dir_openstack_helm_infra }}/tools/gate/devel/local-vars.yaml"
  #    dest: "{{ zuul.executor.log_root }}/"
  #  mode: pull

- name: run helm deployment script
  command: ./helm-deploy.sh
  args:
    chdir: "{{ ansible_env.HOME }}"
  environment:
    BASE_DIR: "{{ src_dir_contrail_helm_deployer }}"  # never used by script?
    OSH_PATH: "{{ src_dir_openstack_helm }}"
    OSH_INFRA_PATH: "{{ src_dir_openstack_helm_infra }}"
    CHD_PATH: "{{ src_dir_contrail_helm_deployer }}"
    CONTRAIL_REGISTRY: "{{ contrail_docker_registry }}"
    CONTAINER_TAG: "{{ container_tag }}"
